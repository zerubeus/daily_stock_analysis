name: Daily Stock Analysis

on:
  # Scheduled trigger - Every weekday at 18:00 Beijing Time (UTC 10:00)
  schedule:
    - cron: '0 10 * * 1-5'     # Mon-Fri, UTC 10:00 = Beijing Time 18:00

  # Manual trigger
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode'
        required: true
        default: 'full'
        type: choice
        options:
          - full          # Full analysis (stocks + market review)
          - market-only   # Market review only
          - stocks-only   # Stock analysis only

# Concurrency control: only one analysis job at a time
concurrency:
  group: stock-analysis
  cancel-in-progress: false

jobs:
  analyze:
    runs-on: ubuntu-latest
    # Timeout to prevent stuck jobs
    timeout-minutes: 30

    steps:
      - name: Random delay (avoid fixed-time access)
        run: sleep $((RANDOM % 60))  # Random 0-60s startup delay

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python environment
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create required directories
        run: |
          mkdir -p data logs reports

      - name: Run stock analysis
        env:
          # ==========================================
          # AI Configuration
          # ==========================================
          # Gemini AI (Primary)
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL || secrets.GEMINI_MODEL || 'gemini-3-flash-preview' }}
          GEMINI_MODEL_FALLBACK: ${{ vars.GEMINI_MODEL_FALLBACK || secrets.GEMINI_MODEL_FALLBACK || 'gemini-2.5-flash' }}
          GEMINI_REQUEST_DELAY: '3.0'

          # OpenAI Compatible API (Fallback)
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ vars.OPENAI_BASE_URL || secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL || secrets.OPENAI_MODEL }}

          # ==========================================
          # Data Sources
          # ==========================================
          TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}

          # ==========================================
          # Search Services
          # ==========================================
          BOCHA_API_KEYS: ${{ secrets.BOCHA_API_KEYS }}
          TAVILY_API_KEYS: ${{ secrets.TAVILY_API_KEYS }}
          SERPAPI_API_KEYS: ${{ secrets.SERPAPI_API_KEYS }}

          # ==========================================
          # Notification Channels (multiple can be configured, all will receive)
          # ==========================================

          # Channel 1: WeChat Work Webhook
          WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
          WECHAT_MSG_TYPE: ${{ vars.WECHAT_MSG_TYPE || secrets.WECHAT_MSG_TYPE || 'markdown' }}

          # Channel 2: Feishu (Lark) Webhook
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}

          # Channel 3: Telegram
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          TELEGRAM_MESSAGE_THREAD_ID: ${{ secrets.TELEGRAM_MESSAGE_THREAD_ID }}

          # Channel 4: Email
          EMAIL_SENDER: ${{ vars.EMAIL_SENDER || secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVERS: ${{ vars.EMAIL_RECEIVERS || secrets.EMAIL_RECEIVERS }}
          EMAIL_SENDER_NAME: ${{ vars.EMAIL_SENDER_NAME || secrets.EMAIL_SENDER_NAME || 'Daily Stock Analysis Assistant' }}

          # Channel 5: Pushover
          PUSHOVER_USER_KEY: ${{ secrets.PUSHOVER_USER_KEY }}
          PUSHOVER_API_TOKEN: ${{ secrets.PUSHOVER_API_TOKEN }}

          # Channel 6: PushPlus
          PUSHPLUS_TOKEN: ${{ secrets.PUSHPLUS_TOKEN }}

          # Channel 7: Custom Webhook (DingTalk, Bark, self-hosted, etc.)
          CUSTOM_WEBHOOK_URLS: ${{ secrets.CUSTOM_WEBHOOK_URLS }}
          CUSTOM_WEBHOOK_BEARER_TOKEN: ${{ secrets.CUSTOM_WEBHOOK_BEARER_TOKEN }}

          # Channel 8: Discord
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
          DISCORD_MAIN_CHANNEL_ID: ${{ secrets.DISCORD_MAIN_CHANNEL_ID }}

          # Channel 9: Feishu Cloud Document
          FEISHU_APP_ID: ${{ secrets.FEISHU_APP_ID }}
          FEISHU_APP_SECRET: ${{ secrets.FEISHU_APP_SECRET }}
          FEISHU_FOLDER_TOKEN: ${{ secrets.FEISHU_FOLDER_TOKEN }}

          # Channel 10: AstrBot
          ASTRBOT_URL: ${{ secrets.ASTRBOT_URL }}
          ASTRBOT_TOKEN: ${{ secrets.ASTRBOT_TOKEN }}

          # Channel 11: ServerChan3
          SERVERCHAN3_SENDKEY: ${{ secrets.SERVERCHAN3_SENDKEY }}

          # ==========================================
          # Watchlist Configuration
          # ==========================================
          STOCK_LIST: ${{ vars.STOCK_LIST || secrets.STOCK_LIST || '600519' }}

          # ==========================================
          # Run Configuration
          # ==========================================
          REPORT_TYPE: ${{ vars.REPORT_TYPE || secrets.REPORT_TYPE || 'simple' }}
          SINGLE_STOCK_NOTIFY: ${{ vars.SINGLE_STOCK_NOTIFY || secrets.SINGLE_STOCK_NOTIFY || 'false' }}
          MARKET_REVIEW_ENABLED: ${{ vars.MARKET_REVIEW_ENABLED || secrets.MARKET_REVIEW_ENABLED || 'true' }}
          ANALYSIS_DELAY: ${{ vars.ANALYSIS_DELAY || secrets.ANALYSIS_DELAY || '0' }}

          # ==========================================
          # System Configuration
          # ==========================================
          LOG_LEVEL: INFO
          MAX_WORKERS: ${{ vars.MAX_WORKERS || secrets.MAX_WORKERS || '1' }}
          # Recommend disabling unstable data sources in GitHub Actions
          ENABLE_CHIP_DISTRIBUTION: 'false'
          # Realtime quote data source priority (Tencent has volume ratio and is stable, recommended first)
          # Options: tencent, akshare_sina, efinance, akshare_em, tushare
          # If you have a high-credit Tushare Pro account, put tushare first
          REALTIME_SOURCE_PRIORITY: ${{ vars.REALTIME_SOURCE_PRIORITY || 'tencent,akshare_sina,efinance,akshare_em' }}

        run: |
          # Determine run mode
          MODE="${{ github.event.inputs.mode || 'full' }}"

          echo "=========================================="
          echo "ðŸš€ Stock Watchlist AI Analysis System"
          echo "=========================================="
          echo "â° Time: $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')"
          echo "ðŸŽ¯ Run mode: $MODE"
          echo "ðŸ“Š Watchlist: $STOCK_LIST"
          echo "ðŸ“ Report type: $REPORT_TYPE"
          echo ""
          echo "=========================================="
          echo "ðŸ“‹ Configuration Check"
          echo "=========================================="
          echo "[AI Config]"
          echo "  Gemini API Key: $([ -n "$GEMINI_API_KEY" ] && echo 'âœ… Configured' || echo 'âŒ Not configured')"
          echo "  OpenAI API Key: $([ -n "$OPENAI_API_KEY" ] && echo 'âœ… Configured' || echo 'âšª Not configured')"
          echo ""
          echo "[Search Engines]"
          echo "  Bocha API Keys: $([ -n "$BOCHA_API_KEYS" ] && echo 'âœ… Configured' || echo 'âšª Not configured')"
          echo "  Tavily API Keys: $([ -n "$TAVILY_API_KEYS" ] && echo 'âœ… Configured' || echo 'âšª Not configured')"
          echo ""
          echo "[Notification Channels]"
          echo "  PushPlus: $([ -n "$PUSHPLUS_TOKEN" ] && echo 'âœ… Configured' || echo 'âšª Not configured')"
          echo "  WeChat Work: $([ -n "$WECHAT_WEBHOOK_URL" ] && echo 'âœ… Configured' || echo 'âšª Not configured')"
          echo "  Feishu: $([ -n "$FEISHU_WEBHOOK_URL" ] && echo 'âœ… Configured' || echo 'âšª Not configured')"
          echo "  Telegram: $([ -n "$TELEGRAM_BOT_TOKEN" ] && echo 'âœ… Configured' || echo 'âšª Not configured')"
          echo "  Discord: $([ -n "$DISCORD_WEBHOOK_URL" ] && echo 'âœ… Configured' || echo 'âšª Not configured')"
          echo "  AstrBot: $([ -n "$ASTRBOT_URL" ] && echo 'âœ… Configured' || echo 'âšª Not configured')"
          echo "=========================================="
          echo ""

          # Run analysis
          if [ "$MODE" = "market-only" ]; then
            python main.py --market-review
          elif [ "$MODE" = "stocks-only" ]; then
            python main.py --no-market-review
          else
            python main.py
          fi

      - name: Upload analysis reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: analysis-reports-${{ github.run_number }}
          path: |
            reports/
            logs/
          retention-days: 30

      - name: Display run results
        if: always()
        run: |
          echo ""
          echo "=========================================="
          echo "ðŸ“Š Analysis Complete"
          echo "=========================================="
          if [ -d "reports" ] && [ "$(ls -A reports 2>/dev/null)" ]; then
            echo "Generated reports:"
            ls -la reports/
          else
            echo "âš ï¸ No report files generated"
          fi
          echo ""
          if [ -f "logs/stock_analysis_$(date +%Y%m%d).log" ]; then
            echo "ðŸ“œ Recent logs (last 30 lines):"
            tail -30 logs/stock_analysis_*.log 2>/dev/null || echo "No logs"
          fi
